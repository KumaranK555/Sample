WITH Budget AS ( 
select Newf2,Newf3,Newf4,Months,sum(CompanyCurrency_HSL) as BudgetFTM from GLPCP 
where Tabflag='Budget'  
and Product !='JJ' and  FiscalYear_RYEAR=(select Max(FiscalYear_RYEAR) from GLPCP ) and Nperiod=4 and Months='Apr'
and NEWF4='FILM CONSUMED'
 group by Newf2,NEWF3,NEWF4,Months
),
Actual  as(
SELECT Newf2,Newf3,Newf4,Months,sum(CompanyCurrency_HSL) as ActualFTM from GLPCP where tabflag='Actual' and 
Product !='JJ' and FiscalYear_Ryear = (select Max(FiscalYear_RYEAR) from GLPCP ) and NPeriod =4 and Months='Apr' 
and NEWF4='FILM CONSUMED'
 group by Newf2,NEWF3,NEWF4,Months
),
JobWork as
(
select Newf2,Newf3,Newf4,Months,sum(CompanyCurrency_HSL) as JobWorkFTM  from GLPCP 
where (Origin_RHOART ='03' or ORIGIN_RHOART='05') and Product !='JJ' and FiscalYear_Ryear = (select Max(FiscalYear_RYEAR) from GLPCP )
 and NPeriod = 4  and Months='Apr' and NEWF4='FILM CONSUMED'
 group by Newf2,NEWF3,NEWF4,Months
),

BudgetYTDt as
(
select Newf2,Newf3,Newf4,Months,sum(CompanyCurrency_HSL) as BudgetYTD  from GLPCP 
where TabFlag='Budget'  and Months='Apr' and  Product !='JJ' and FiscalYear_Ryear = (select Max(FiscalYear_RYEAR) 
from GLPCP )  and NEWF4= 'FILM CONSUMED' group by Newf2,NEWF3,NEWF4,Months
),
ActualYTDt as
(
select Newf2,Newf3,Newf4,Months,sum(CompanyCurrency_HSL) as ActualYTD  from GLPCP 
where TabFlag='Actual'  and Months='Apr'   and Product !='JJ' and FiscalYear_Ryear = (select Max(FiscalYear_RYEAR) 
from GLPCP ) and NEWF4= 'FILM CONSUMED' group by Newf2,NEWF3,NEWF4,Months

),
JobWorkYTDt as
(
select Newf2,Newf3,Newf4,Months,sum(CompanyCurrency_HSL) as JobWorkYTD  from GLPCP 
where (Origin_RHOART =03 or Origin_RHOART=05) and Product !='JJ' and FiscalYear_Ryear = (select Max(FiscalYear_RYEAR) 
from GLPCP) and  Months='Apr' and NEWF4= 'FILM CONSUMED' group by Newf2,NEWF3,NEWF4,Months
)

select Budget.Newf2,
Budget.Newf3,
Budget.NEWF4,
Budget.MONTHS,
Round(Budget.BudgetFTM,0) as BudgetFTM,
 Round(Actual.ActualFTM,0) as ActualFTM,
 Round(NVL(JobWork.JobWorkFTM,0) ,0) as JobWorkFTM,
Round(Nvl(ACTUAL.ACTUALFTM,0) - NVL(JOBWORK.JOBWORKFTM,0),0) as AdjActualFTM,
Round(Nvl(Budget.BudgetFTM,0),0)- Round(Nvl(ACTUAL.ACTUALFTM,0) - NVL(JOBWORK.JOBWORKFTM,0),0) as VarianceFTM, 
Round(((Budget.BudgetFTM - (Actual.ActualFTM - NVL(JobWork.JobWorkFTM,0)))/nullif(Budget.BudgetFTM,0)*100),0) as Var, 
Round(BudgetYTDt.BudgetYTD,0) as BudgetYTD,
Round(ActualYTDt.ActualYTD,0) as ActualYTD,
Round(NVL(JobWorkYTDt.JobWorkYTD,0),0)as JobWorkYTD,
Round((ActualYTDt.ActualYTD - NVL(JobWorkYTDt.JobWorkYTD,0)),0) as AdjActualYtd,
Round(BudgetYTDt.BudgetYTD,0)- Round((ActualYTDt.ActualYTD - NVL(JobWorkYTDt.JobWorkYTD,0)),0) as VaianceYtd,
Round(((BudgetYTDt.BudgetYTD - (ActualYTDt.ActualYTD - NVL(JobWorkYTDt.JobWorkYTD,0)))/nullif(BudgetYTDt.BudgetYTD,0)*100),0) as Varytd
from Budget left join Actual ON
BUDGET.NEWF2=actual.NEWF2 and 
BUDGET.Newf3=actual.Newf3 and
BUDGET.NEWF4=actual.NEWF4 

left join JobWork on
Budget.NEWF2=JobWork.NEWF2 and 
Budget.Newf3=JobWork.Newf3 and
Budget.NEWF4=JobWork.NEWF4 

left join BudgetYTDt on
Budget.NEWF2=BudgetYTDt.NEWF2 and 
Budget.Newf3=BudgetYTDt.Newf3 and
Budget.NEWF4=BudgetYTDt.NEWF4 

left join ActualYTDt on
Budget.NEWF2=ActualYTDt.NEWF2 and 
Budget.Newf3=ActualYTDt.Newf3 and
Budget.NEWF4=ActualYTDt.NEWF4 

left join JobWorkYTDt on
Budget.NEWF2=JobWorkYTDt.NEWF2 and 
Budget.Newf3=JobWorkYTDt.Newf3 and
Budget.NEWF4=JobWorkYTDt.NEWF4